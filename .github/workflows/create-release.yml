name: create-release

on:
  push:
    branches:
      - main
      - develop
    tags:
      - '*'

jobs:
  create-release:

    runs-on: ubuntu-18.04

    steps:
      - name: Check out repository
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'

      - name: download and extract latest miner-tools release
        run: |
          PMG_OPENCL_URL="https://github.com/tontechio/pow-miner-gpu/releases/latest/download/minertools-opencl-ubuntu-18.04-x86-64.tar.gz"
          PMG_CUDA_URL="https://github.com/tontechio/pow-miner-gpu/releases/latest/download/minertools-cuda-ubuntu-18.04-x86-64.tar.gz"
          wget -O minertools-opencl-ubuntu-18.04-x86-64.tar.gz $PMG_OPENCL_URL
          wget -O minertools-cuda-ubuntu-18.04-x86-64.tar.gz $PMG_CUDA_URL
          tar -xf minertools-opencl-ubuntu-18.04-x86-64.tar.gz -C ./assets/
          tar -xf minertools-cuda-ubuntu-18.04-x86-64.tar.gz -C ./assets/
          rm -f minertools-opencl-ubuntu-18.04-x86-64.tar.gz
          rm -f minertools-cuda-ubuntu-18.04-x86-64.tar.gz

      - name: download latest blockchain config
        run: |
          BLOCK_CHAIN_GC_URL="https://newton-blockchain.github.io/global.config.json"
          wget -O ./config/global.config.json $BLOCK_CHAIN_GC_URL

      - name: define modes for files
        run: |
          chmod +x ./assets/pow-miner-opencl
          chmod +x ./assets/tonlib-opencl-cli
          chmod +x ./assets/pow-miner-cuda
          chmod +x ./assets/tonlib-cuda-cli
          chmod +x ./assets/lite-client

      - name: cuda variable substitution
        uses: jacobtomlinson/gha-find-replace@v2
        with:
          find: "{{ type }}"
          replace: "cuda"
          regex: false
          include: "**h-config.sh"

      - name: prepare cuda assets
        run: |
          GENERAL="README.md ./config/global.config.json ./h-config.sh ./h-manifest.conf ./h-run.sh ./h-stats.sh"
          CUDA="./assets/lite-client ./assets/pow-miner-cuda ./assets/tonlib-cuda-cli"
          mkdir minertools-cuda-hiveos-0.6-x86-64
          cp --parents $GENERAL $CUDA ./minertools-cuda-hiveos-0.6-x86-64/
          tar -zcf minertools-cuda-hiveos-0.6-x86-64.tar.gz ./minertools-cuda-hiveos-0.6-x86-64

      - name: opencl variable substitution
        uses: jacobtomlinson/gha-find-replace@v2
        with:
          find: "{{ type }}"
          replace: "opencl"
          regex: false
          include: "**h-config.sh"

      - name: prepare opencl assets
        run: |
          GENERAL="README.md ./config/global.config.json ./h-config.sh ./h-manifest.conf ./h-run.sh ./h-stats.sh"
          OPENCL="./assets/lite-client ./assets/pow-miner-opencl ./assets/tonlib-opencl-cli"
          mkdir minertools-opencl-hiveos-0.6-x86-64
          cp --parents $GENERAL $OPENCL ./minertools-opencl-hiveos-0.6-x86-64/
          tar -zcf minertools-opencl-hiveos-0.6-x86-64.tar.gz ./minertools-opencl-hiveos-0.6-x86-64

      - name: packing
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: minertools-*-hiveos-0.6-x86-64.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}

